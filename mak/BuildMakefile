###############################################################################
##
## Makefile for Pegasus CIMOM
##
## NOTE: Makefile needs to be executed from the parent directory of 
## pegasus directory because the path settings are relative and this
## Makefile may remove and recheckout the pegasus source tree.
##
## Options:
##      cleanbuild - Removes the existing pegasus directory contents, performs
##                   checkout, build and runs tests. 
##      rebuild    - Rebuild and execute tests.
## 
###############################################################################

###############################################################################
##
## Platform specific settings for HP-UX
##
## NOTE: Please add platform specific environment variables as appropriate. 
##
###############################################################################

ifeq ($(PEGASUS_PLATFORM),WIN32_IX86_MSVC)
  CIMSERVER_START_SERVICE =
  CIMSERVER_STOP_SERVICE =
  SLEEP =
  REMOVE_PEGASUS_DIRECTORY = mu rmdirhier pegasus
  MUEXE = mu.exe
  COPYMU = copy pegasus\src\utils\mu\$(MUEXE) /y $(MUEXE)
  MKDIR = pegasus/src/utils/mu/mu mkdirhier
  TESTS = prestarttests
endif

ifeq ($(PEGASUS_PLATFORM),HPUX_PARISC_ACC)
  CIMSERVER_START_SERVICE = cimserver -d
  CIMSERVER_STOP_SERVICE = /usr/bin/ps -ef | /usr/bin/grep cimserver | /usr/bin/grep -v grep | /usr/bin/awk '{print "kill -9 "$$2 |"/usr/bin/sh"}'
  SLEEP = sleep 5
  REMOVE_PEGASUS_DIRECTORY = rm -Rf pegasus.old; mv pegasus pegasus.old
  MUEXE = mu
  COPYMU = cp -f pegasus/src/utils/mu/$(MUEXE) /usr/local/bin/$(MUEXE)
  MKDIR = pegasus/src/utils/mu/mu mkdirhier
  TESTS = prestarttests poststarttests
endif

error: 
	@ echo "Specify desired makefile option (i.e., cleanbuild, rebuild)"

buildmu:
	$(MAKE) --directory=pegasus/src/utils/mu -f Makefile
	$(COPYMU)
	
cleanbuild: removeall recheckout buildmu all $(TESTS) 

recheckout: removeall checkout

removeall:
	$(REMOVE_PEGASUS_DIRECTORY)

checkout:
	cvs checkout pegasus
	
rebuild: clean buildmu all tests

all: buildmu
	$(MAKE) --directory=pegasus -f Makefile depend
	$(MAKE) --directory=pegasus -f Makefile all

doc:
	$(MAKE) --directory=pegasus/doc/ProviderSpec -f Makefile
	$(MAKE) --directory=pegasus/doc/DevManual -f Makefile

clean:
	$(MAKE) --directory=pegasus -f Makefile clean

		
prestarttests: 
	$(CIMSERVER_STOP_SERVICE)
	$(SLEEP)
	$(MAKE) --directory=pegasus -f Makefile repository
	$(MAKE) --directory=pegasus -f Makefile tests
	$(MAKE) --directory=pegasus/src/Server -f Makefile install
	$(MAKE) --directory=pegasus/test -f Makefile clean

poststarttests:
	$(CIMSERVER_START_SERVICE)
	$(SLEEP)
	TestClient
	Client
	$(MAKE) --directory=pegasus/test -f Makefile tests
	@ echo Terminating cimserver...
	@ $(CIMSERVER_STOP_SERVICE)

tests: $(TESTS)
	@ echo Finished Tests

###############################################################################
##
## Trace Configuration
##
## Options:
##      XMLTraceOn: Enables XML request and response tracing.
##      ProviderLoadTraceOn: Enables Provider load tracing.
##      XML+ProviderLoadTraceOn: Enables both XML request/response and Provider
##                                 load tracing.
##      AllTraceOn: Enables all tracing.
##      AllTraceOff: Disables all tracing.
##      list: Lists trace settings.
##
###############################################################################

XMLTraceOn:
	cimconfig -s traceComponents=XmlIO -c
	cimconfig -s traceLevel=3 -c
	cimconfig -g traceComponents
	cimconfig -g traceLevel

ProviderLoadTraceOn:
	cimconfig -s traceComponents=ProvManager,OsAbstraction
	cimconfig -s traceLevel=3 -c
	cimconfig -g traceComponents
	cimconfig -g traceLevel

XML+ProviderLoadTraceOn:
	cimconfig -s traceComponents=XmlIO,ProvManager,OsAbstraction
	cimconfig -s traceLevel=3 -c
	cimconfig -g traceComponents
	cimconfig -g traceLevel

AllTraceOn:
	cimconfig -s traceComponents=ALL
	cimconfig -s traceLevel=3 -c
	cimconfig -g traceComponents
	cimconfig -g traceLevel

AllTraceOff:
	cimconfig -s traceComponents=
	cimconfig -g traceComponents
	cimconfig -g traceLevel

list:
	cimconfig -g traceComponents
	cimconfig -g traceLevel
	cimconfig -g traceFilePath

# DO NOT DELETE
