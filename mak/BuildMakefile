###############################################################################
##
## Makefile for Pegasus CIMOM
##
## NOTE: Makefile needs to be executed from the parent directory of 
## pegasus directory because the path settings are relative and this
## Makefile may remove and recheckout the pegasus source tree.
##
## Options:
##      cleanbuild - Removes the existing pegasus directory contents, performs
##                   checkout, build and runs tests. 
##      rebuild    - Rebuild and execute tests.
## 
###############################################################################

###############################################################################
##
## Platform specific settings for several platforms.
##
## NOTE: Please add platform specific environment variables as appropriate. 
##
###############################################################################

include pegasus/mak/config.mak

# There is a start command for cimserver but no stop today.  Because of problems with
# the use of cimserver as a service, we simply used the start command to allow us to
# get on with testing. I know of no CLI to stop a window started with start so that
# field is blank.  ks 7 April 2002
ifeq ($(PEGASUS_PLATFORM),WIN32_IX86_MSVC)
  CIMSERVER_START_SERVICE = start cimserver
  CIMSERVER_STOP_SERVICE =
  SLEEP =
  REMOVE_PEGASUS_DIRECTORY = mu rmdirhier pegasus
  MUEXE = mu.exe
  COPYMU = copy pegasus\src\utils\mu\$(MUEXE) /y $(MUEXE)
  MKDIR = pegasus/src/utils/mu/mu mkdirhier
  TESTS = prestarttests
endif

ifeq ($(OS),HPUX)
  CIMSERVER_START_SERVICE = cimserver
  CIMSERVER_STOP_SERVICE = cimserver -s
  SLEEP = sleep 5
  REMOVE_PEGASUS_DIRECTORY = rm -Rf pegasus.old; mv pegasus pegasus.old
  MUEXE = mu
  COPYMU = cp -f pegasus/src/utils/mu/$(MUEXE) $(BIN_DIR)/$(MUEXE)
  MKDIR = pegasus/src/utils/mu/mu mkdirhier
  TESTS = prestarttests poststarttests
endif

ifeq ($(PEGASUS_PLATFORM),LINUX_IX86_GNU)
  CIMSERVER_START_SERVICE = cimserver
  CIMSERVER_STOP_SERVICE = /bin/ps -ef | /bin/grep cimserver | /bin/grep -v grep | /usr/bin/awk '{print "kill -9 "$$2 |"/bin/bash"}'
  SLEEP = sleep 5
  REMOVE_PEGASUS_DIRECTORY = rm -Rf pegasus.old; mv pegasus pegasus.old
  MUEXE = mu
  COPYMU = cp -f pegasus/src/utils/mu/$(MUEXE) $(BIN_DIR)/$(MUEXE)
  MKDIR = pegasus/src/utils/mu/mu mkdirhier
  TESTS = prestarttests poststarttests
endif

ifeq ($(PEGASUS_PLATFORM),LINUX_IA64_GNU)
  CIMSERVER_START_SERVICE = cimserver
  CIMSERVER_STOP_SERVICE = /bin/ps -ef | /bin/grep cimserver | /bin/grep -v grep | /usr/bin/awk '{print "kill -9 "$$2 |"/bin/bash"}'
  SLEEP = sleep 5
  REMOVE_PEGASUS_DIRECTORY = rm -Rf pegasus.old; mv pegasus pegasus.old
  MUEXE = mu
  COPYMU = cp -f pegasus/src/utils/mu/$(MUEXE) $(BIN_DIR)/$(MUEXE)
  MKDIR = pegasus/src/utils/mu/mu mkdirhier
  TESTS = prestarttests poststarttests
endif

ifeq ($(DYNAMIC_SOCKSIFY),TRUE)
  CVS = socksify cvs
else
  CVS = cvs
endif

error: 
	@ echo "Specify desired makefile option (i.e., cleanbuild, rebuild)"

buildmu:
	$(MAKE) --directory=pegasus/src/utils/mu -f Makefile
	$(MKDIR) $(BIN_DIR)
	$(COPYMU)
	
cleanbuild: removeall recheckout buildmu all $(TESTS) 

recheckout: removeall checkout

removeall:
	$(REMOVE_PEGASUS_DIRECTORY)

checkout:
	$(CVS) checkout pegasus
	
rebuild: clean buildmu all tests

build: all tests

all: buildmu
	$(MAKE) --directory=pegasus -f Makefile depend
	$(MAKE) --directory=pegasus -f Makefile all

doc:
	$(MAKE) --directory=pegasus/doc/ProviderSpec -f Makefile
	$(MAKE) --directory=pegasus/doc/DevManual -f Makefile

clean:
	$(MAKE) --directory=pegasus -f Makefile clean

repositoryServer: 
	$(CIMSERVER_STOP_SERVICE)
	$(SLEEP)
	$(RMDIRHIER) $(REPOSITORY_ROOT)
	$(CIMSERVER_START_SERVICE)
	$(SLEEP)
	$(MAKE) --directory=pegasus -f Makefile repositoryServer
	$(MAKE) --directory=pegasus -f Makefile testrepositoryServer
		
prestarttests: 
	$(CIMSERVER_STOP_SERVICE)
	$(SLEEP)
	$(MAKE) --directory=pegasus -f Makefile repository
	$(MAKE) --directory=pegasus -f Makefile testrepository
	$(MAKE) --directory=pegasus -f Makefile tests
	$(MAKE) --directory=pegasus/src/Server -f Makefile install

poststarttests:
	$(MAKE) --directory=pegasus/test/wetest -f Makefile clean
	$(CIMSERVER_START_SERVICE)
	$(SLEEP)
	$(MAKE) --directory=pegasus -f Makefile poststarttests

tests: $(TESTS)
	@ echo Finished Tests

###############################################################################
##
## Trace Configuration
##
## Options:
##      XMLTraceOn: Enables XML request and response tracing.
##      ProviderLoadTraceOn: Enables Provider load tracing.
##      XML+ProviderLoadTraceOn: Enables both XML request/response and Provider
##                                 load tracing.
##      AllTraceOn: Enables all tracing.
##      AllTraceOff: Disables all tracing.
##      list: Lists trace settings.
##
###############################################################################

XMLTraceOn:
	cimconfig -s traceComponents=XmlIO -c
	cimconfig -s traceLevel=3 -c
	cimconfig -g traceComponents
	cimconfig -g traceLevel

ProviderLoadTraceOn:
	cimconfig -s traceComponents=ProvManager,OsAbstraction
	cimconfig -s traceLevel=3 -c
	cimconfig -g traceComponents
	cimconfig -g traceLevel

XML+ProviderLoadTraceOn:
	cimconfig -s traceComponents=XmlIO,ProvManager,OsAbstraction
	cimconfig -s traceLevel=3 -c
	cimconfig -g traceComponents
	cimconfig -g traceLevel

AllTraceOn:
	cimconfig -s traceComponents=ALL
	cimconfig -s traceLevel=3 -c
	cimconfig -g traceComponents
	cimconfig -g traceLevel

AllTraceOff:
	cimconfig -s traceComponents=
	cimconfig -g traceComponents
	cimconfig -g traceLevel

list:
	cimconfig -g traceComponents
	cimconfig -g traceLevel
	cimconfig -g traceFilePath

# DO NOT DELETE
